#!/usr/bin/env bash
# AITS INFRA DISCOVERY SCRIPT
# Runs on ANY Replit (HyperDAG, PurposeHub, or Mel)
# Reports: Replit, Supabase, GitHub, Flutter, Keys
# Sends to: Supabase + GitHub Issue

# === CHANGE THESE 4 LINES ONLY ===
REPLIT_OWNER="your-replit-username"           # e.g. hyperdagjohn
SUPABASE_URL="https://qnnpjhlxljtqyigedwkb.supabase.co"
SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6..."  # ← GET FROM SUPABASE (Step 2)
GITHUB_REPO="DealAppSeo/trinity-symphony-shared"
# ==================================

NOW=$(date -u +"%Y-%m-%d %H:%M:%SZ")
AGENT=$(hostname | cut -d'.' -f1 | tr '[:lower:]' '[:upper:]')  # Auto-detect: HYPERDAG, PURPOSEHUB, etc.

log() { echo "[$AGENT] $*"; }

send_to_supabase() {
  curl -s -X POST "$SUPABASE_URL/rest/v1/infrastructure_audit" \
    -H "apikey: $SUPABASE_KEY" \
    -H "Authorization: Bearer $SUPABASE_KEY" \
    -H "Content-Type: application/json" \
    -d "{\"agent_id\":\"$AGENT\",\"component\":\"$1\",\"status\":\"$2\",\"url\":\"$3\",\"details\":\"$4\",\"discovered_at\":\"$NOW\"}" \
    > /dev/null
  log "Reported: $1"
}

# 1. REPLIT CHECK
REPL_URL=$(curl -s "https://replit.com/api/v1/repls?owner=$REPLIT_OWNER" | jq -r '.[0].url // "none"')
send_to_supabase "Replit" "active" "$REPL_URL" "Running as $AGENT"

# 2. SUPABASE TABLES CHECK (APM STYLE)
TABLE_COUNT=$(curl -s "$SUPABASE_URL/rest/v1/rpc/table_info?schema=public" -H "apikey: $SUPABASE_KEY" | jq 'length')
TASK_COUNT=$(curl -s "$SUPABASE_URL/rest/v1/trinity_tasks?select=count(*)" -H "apikey: $SUPABASE_KEY" | jq '.[0].count // 0')
send_to_supabase "Supabase" "active" "$SUPABASE_URL" "trinity_tasks: $TASK_COUNT rows, $TABLE_COUNT tables"

# 3. GITHUB REPOS CHECK
REPO_COUNT=$(gh repo list "$REPLIT_OWNER" --limit 100 --json name | jq '[.[] | select(.name | test("trinity|hyperdag|purposehub|imagebearer|ats"))] | length')
send_to_supabase "GitHub" "active" "https://github.com/$GITHUB_REPO" "$REPO_COUNT matching repos"

# 4. FLUTTER APP CHECK
FLUTTER_FILES=$(find . -name "pubspec.yaml" -o -name "*.dart" | wc -l)
if [ $FLUTTER_FILES -gt 0 ]; then
  send_to_supabase "Flutter" "active" "$(pwd)" "$FLUTTER_FILES Dart files → Controller app found"
else
  send_to_supabase "Flutter" "missing" "" "No pubspec.yaml → No mobile/web app"
fi

# 5. BYOK KEYS CHECK
KEY_COUNT=$(curl -s "$SUPABASE_URL/rest/v1/user_keys?select=count(*)" -H "apikey: $SUPABASE_KEY" | jq '.[0].count // 0')
send_to_supabase "BYOK" "active" "$SUPABASE_URL" "$KEY_COUNT user keys stored"

# 6. MEL / LOVABLE CHECK
if grep -q "lovable" .replit 2>/dev/null || grep -q "imagebearer" README.md 2>/dev/null; then
  send_to_supabase "Mel" "active" "https://imagebearer.org" "Lovable + ImageBearer detected"
fi

log "Discovery complete. Check Supabase + GitHub issue."